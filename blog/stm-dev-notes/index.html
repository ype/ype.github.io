<!DOCTYPE html><html><head><link href="http://gmpg.org/xfn/11" rel="profile"><meta http-equiv="content-type" content="text/html; charset=utf-8"><link rel="canonical" href="http://ype.env.sh/blog/stm-dev-notes" /><meta name="description" content="This article will go through the required steps to setup an environment for writing, programming, and debugging code for ARM..." /><meta property="og:description" content="This article will go through the required steps to setup an environment for writing, programming, and debugging code for ARM..." /><meta itemprop="image" content="http://ype.env.sh/media/2014-01-22-stm-dev-notes/STM32-103STK-REV-B-sch.gif" /><meta property="og:image" content="http://ype.env.sh/media/2014-01-22-stm-dev-notes/STM32-103STK-REV-B-sch.gif" /><meta property="og:title" content="Get Things Done:<br/>STM32 Development" /><meta property="og:type" content="article" /><meta property="og:url" content="http://ype.env.sh/blog/stm-dev-notes" /><meta property="og:site_name" content="ype" /><title>Get Things Done:<br/>STM32 Development &middot; ype</title><meta name="mobile-web-app-capable" content="yes"><meta name="HandheldFriendly" content="True" /><meta name="MobileOptimized" content="320" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="stylesheet" href="/assets/fonts-bbb14e452c4635e377cc74558d6d5d91.css"><link rel="stylesheet" href="/assets/app-5e18dae3ca9bdf5eb29d0c32b3152bf1.css"><link rel="stylesheet" type="text/css" media="only screen and (min-width: 721px)" href="/assets/desktop-efd7e8be9ec01040b4f3044eca618125.css" /><link rel="stylesheet" type="text/css" media="only screen and (max-width: 720px)" href="/assets/mobile-78bbfa23d208e532469d1cca6ebf3930.css" /><link rel="apple-touch-icon" href="http://ype.env.shicon.png"><link rel="shortcut icon" href="http://ype.env.sh/assets/images/favicon.ico"><link rel="alternate" type="application/rss+xml" title="RSS" href="http://ype.env.sh/atom.xml"></head><body><div id="top"></div><header class="clean" style="background-image: url(/media/2014-01-22-stm-dev-notes/STM32-103STK-REV-B-sch.gif); height: 100%;"><div id="menu-block"><div class="menu-content"><a href="/">Home</a><a href="/about">About</a><a href="/archive">Archive</a><a href="/racd/clustered">Clustered</a><a href="/racd/embedded">Embedded</a></div><div class="social-links"><a href="https://github.com/ype" target="_blank" title="Fork me"><span class="genericon genericon-github"></span></a><a href="https://www.linkedin.com/in/01100001" target="_blank" title="linkedin"><span class="genericon genericon-linkedin"></span></a><a href="http://ype.env.sh/atom.xml" target="_blank" title="Feed"><span class="genericon genericon-feed"></span></a></div></div><div id="post-info-background"><div id="post-info"><h1>Get Things Done:<br/>STM32 Development</h1><h2>Install, Compile, Debug</h2><h3>22 January 2014</h3><h3>Reading time: 3 minutes</h3></div></div><div id="nav-icon" style="bottom: 2.5%;"><a class="scroll" data-speed="1000" href="#article"><span class="genericon genericon-expand"></span></a></div></header><div id="article"><div id="post"><div class="post-content"><p><span class="dropcap">T</span>his article will go through the required steps to setup an environment for writing, programming, and debugging code for ARM Cortex-M processor. As I am predominately a OS X user (sometimes Linux depending on my mood) the information provided is tailored towards OS X users, however, as all of the tools used in the setup are open-source, the information should be transferable to other platforms.</p><h1>Setup</h1><h2>Parts List</h2><p><a href="http://uk.farnell.com/stmicroelectronics/stm32vldiscovery/stm32f100-st-link-discovery-kit/dp/1824325">ST STM32VL-DISCOVERY board</a>- or any other ARM Cortex-M Processor, however most of the examples shown will be for the STM32VL</p><p><a href="http://uk.farnell.com/jsp/search/productdetail.jsp?SKU=1892523">ST-Link/v2</a> (or other compatible ICD/Programmer, for STM32)</p><ul><li>NOTE: If you have the STM32VL-Discovery board, there is an ST-Link built-in, and it is not required to get an external ST-Link, however if you plan on developing custom projects built around the ST range of microcontrollers it may be worth to get one.</li></ul><p><strong>You will also need:</strong></p><ul><li>Wires, LED and other components you may want to play around with, note that for each example I will list the parts used with links to where you can get them.</li><li>A computer, but given you are reading this I am going to assume you have one.</li></ul><h2>Toolchain</h2><h3>Homebrew installation</h3><p>To manage packages on my mac (OS X 10.9), I use homebrew, so I will show you how to set that up, however if you are on Linux, or prefer a different package manager (i.e. macports), most of these packages should be available. You can also alternatively install all of these packages manually, though I would advise against it, as in my experience it can be a road riddled with bugs.</p><p><em>Homebrew install</em></p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>ruby -e <span class="s2">&quot;$(curl -fsSL https://raw.github.com/mxcl/homebrew/go)&quot;</span>
<span class="nv">$ </span>brew doctor
</code></pre></div><h3>gcc-arm-none-eabi install</h3><p>You are going to need a compiler to generate your object code that will be loaded onto your microcontroller. To do this you are going to need a toolchain. The GNU toolchain for ARM Cortex-M and Cortex-R processors is really great, and can be easily installed using homebrew.</p><p>(Note: you can use an IDE for ARM development, however the examples and instructions here are built around the GNU ARM toolchain. Further, if you are developing on OS X or Linux IDE support for ARM development is limited with most being built specifically for Windows)</p><p><em>Installing the GNU Toolchain with Homebrew</em></p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>brew install https://raw.github.com/PX4/homebrew-px4/master/gcc-arm-none-eabi-47.rb
</code></pre></div><hr><h2>ST-LINK</h2><p>The ST-Link (or compatible ICD/Programmer) is essential for ARM microcontroller development. It is an in-circuit debugger and programmer for the STM8 and STM32 microntroller families.</p><h3>Installing ST-Link Utils using Homebrew</h3><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>brew install automake autoconf libusb libusb-compat
<span class="nv">$ </span>sudo easy_install pyyaml
<span class="nv">$ </span>mkdir ~/Development
<span class="nv">$ </span><span class="nb">cd</span> ~/Development
<span class="nv">$ </span>mkdir ~/Development/embedded
<span class="nv">$ </span><span class="nb">cd</span> ~/Development/embedded
<span class="nv">$ </span>mkdir ~/Development/embedded/tools
<span class="nv">$ </span><span class="nb">cd</span> ~/Development/embedded/tools
<span class="nv">$ </span>git clone https://github.com/texane/stlink.git
<span class="c">#ST-LINK command line utility</span>
<span class="c">#Source: https://github.com/texane/stlink</span>
<span class="nv">$ </span><span class="nb">cd</span> ~/Development/embedded/tools/stlink/
<span class="nv">$ </span>./autogen.sh
<span class="nv">$ </span>./configure
<span class="nv">$ </span>make
</code></pre></div><h3>Extra Configurations for ST-Link/v1</h3><p>The ST-Link/v1&rsquo;s SCSI emulation is very broken, You will need to tell your operating system to ignore the ST-Link/v1, as the SCSI emulation on it doesn&rsquo;t play nice with UNIX systems.</p><p><em>Do one of the following before using your ST-Link</em></p><p><strong>Option 1:</strong></p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>modprobe -r usb-storage
<span class="nv">$ </span>modprobe usb-storage <span class="nv">quirks</span><span class="o">=</span>483:3744:i
</code></pre></div><p><strong>Option 2:</strong></p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="c">#add &quot;options usb-storage quirks=483:3744:i&quot; to /etc/modprobe.conf</span>
<span class="c">#then</span>
<span class="nv">$ </span>modprobe -r usb-storage
<span class="nv">$ </span>modprobe usb-storage
</code></pre></div><p><strong>Option 3:</strong></p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>cp stlink_v1.modprobe.conf /etc/modprobe.d
<span class="c">#then</span>
<span class="nv">$ </span>modprobe -r usb-storage
<span class="nv">$ </span>modprobe usb-storage
</code></pre></div><h3>Notes forST-Link/v2</h3><p>The ST-Link/v2 should work right away, nevertheless, doing the above fix for STLINKv1 won&rsquo;t hurt anything and will prevent you from having to do the work later if you are using an ST-Link/v1.</p><h3>Using ST-Util</h3><ul><li>You must launch st-util with &ldquo;-1&rdquo; flag <a href="https://github.com/texane/stlink/issues/182">(source)</a></li></ul><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span>/path_to_stlink/st-utils -1
<span class="c">#or if you have added the stlink folder to your path</span>
<span class="nv">$ </span>st-utils -1
</code></pre></div><hr><h1>Setting up a Development Environment for STM32 Projects</h1><h2>Option 1, Firmware Lib =&gt; Simple</h2><h3>libopencm3<a id="sec-2-1-1" name="sec-2-1-1"></a></h3><p>The libopencm3 project is a good place to start with ST programming. Featuring a large free/libre/open-source (LGPL v3, or later) firmware library for various ARM Cortex-M3 microcontrollers, including the ST STM32 range, libopencm3 offers examples, community and documentation to help for a smooth transition from Arduino to ARM.</p><p>To get more familiar with libopencm3 go to there main wiki @ <a href="http://libopencm3.org/wiki/Main_Page"><a href="http://libopencm3.org/wiki/Main_Page">http://libopencm3.org/wiki/Main_Page</a></a></p><h3>libopencm3 quick start</h3><p>The code below will help you to setup a workflow to develop for ARM Cortex-M microcontrollers using the resources available from libopencm3.</p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd</span> ~/Development/embedded/
<span class="nv">$ </span>git clone https://github.com/libopencm3/libopencm3-examples.git
<span class="nv">$ </span><span class="nb">cd </span>libopencm3-examples
<span class="nv">$ </span>git submodule init
<span class="nv">$ </span>git submodule update
<span class="nv">$ </span>make
</code></pre></div><p><em>Test to see everything works</em></p><p>(Note: The Example below is for the <a href="http://www.st.com/st-web-ui/static/active/en/resource/technical/document/user_manual/CD00267113.pdf">ST STM32VL-DISCOVERY board</a>)</p><div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>examples/stm32/f1/stm32vl-discovery/miniblink/
<span class="nv">$ </span>make
<span class="nv">$ </span><span class="nb">cd</span> ~/Development/embedded/tools/stlink/
<span class="nv">$ </span>./st-util
<span class="c">#Short way</span>
<span class="nv">$ </span>arm-none-eabi-gdb miniblink.elf -ex <span class="s2">&quot;tar ext :4242&quot;</span>
<span class="o">(</span>gdb<span class="o">)</span> load
<span class="o">(</span>gdb<span class="o">)</span> <span class="k">continue</span>
</code></pre></div><h2>Option 2, Bare Metal =&gt; Fiddly</h2><ul><li>(Coming Soonish)</li></ul><h1>Helpful resources</h1><p>Here is a list of helpful links to tutorials and information to get you started on the path to development using ARM microcontrollers</p><ul><li><p><strong>STM32 Open Source Course</strong></p><ul><li><a href="http://homes.soic.indiana.edu/geobrown/c335.php">Course Page</a></li><li><a href="https://github.com/geoffreymbrown/STM32-Template">Build template for projects using the STM32VL-Discovery Board</a></li><li>Book<ul><li><a href="http://www.cs.indiana.edu/%7Egeobrown/book.pdf">Discovering the STM32 Microcontroller</a></li></ul></li></ul></li><li><p><strong>libopencm3</strong></p><ul><li><a href="http://libopencm3.org/wiki/Main_Page">Wiki - Main Project Page</a></li><li><a href="https://github.com/libopencm3/libopencm3">github/libopencm3</a></li><li><a href="https://github.com/libopencm3/libopencm3-examples">github/libopencm3-examples</a></li><li><a href="http://libopencm3.github.io/docs/latest/stm32f1/html/modules.html">libopencm3 API Documentation</a></li></ul></li><li><p><strong>Reference Manuals</strong></p><ul><li><a href="http://infocenter.arm.com/help/topic/com.arm.doc.ddi0337h/DDI0337H_cortex_m3_r2p0_trm.pdf">Cortex-M3 Reference Manual</a></li><li><a href="http://www.st.com/web/en/resource/technical/document/reference_manual/CD00171190.pdf">RM0008: STM32F1xx</a></li><li><a href="http://www.st.com/web/en/resource/technical/document/reference_manual/CD00246267.pdf">RM0041: STM32F100xx</a></li></ul></li></ul></div><hr /><div id="disqus_thread"></div><script type="text/javascript">/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */var disqus_shortname = 'ypenv'; // required: replace example with your forum shortname/* * * DON'T EDIT BELOW THIS LINE * * */(function() {var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><div id="nav-icon" style="bottom: 30px; left: 90%;"><a class="scroll" data-speed="1000" href="#article"><span class="genericon genericon-collapse"></span></a></div><p class="copyright">&copy;2014, <a href="http://ype.env.sh" target="_blank">anton</a>. <a href="http://www.wtfpl.net/" target="_blank">Some rights might be reserved, who really cares?</a>.</p></div><footer class="clean" style="background-image: url(/media/2014-04-08-silver-searching-in-emacs/silverSearcher.gif);;"><div id="post-info-background"><div id="post-info"><h2>Featured post</h2><a href="/blog/silver-searching-in-emacs"><h1>Silver Searching in Emacs</h1><h2>Get Stuff Done, FAST!</h2></a></div></div></footer><script src="/assets/js/smooth-scroll.js"></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', 'UA-53880831-2', 'auto');ga('require', 'displayfeatures');ga('require', 'linkid', 'linkid.js');ga('send', 'pageview');</script></body></html>